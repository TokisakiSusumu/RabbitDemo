@page "/"
@using Microsoft.AspNetCore.SignalR.Client
@using Shared
@implements IAsyncDisposable
@rendermode InteractiveAuto

<h3>Live Notifications</h3>

@if (!_messages.Any())
{
    <p>Waiting for messages...</p>
}
else
{
    @foreach (var msg in _messages)
    {
        <div style="padding:12px; margin:8px 0; background:#f5f5f5; border-radius:6px; border-left:4px solid #4a90d9;">
            <div><strong>@msg.Timestamp.ToLocalTime().ToString("HH:mm:ss")</strong> — @msg.Content</div>

            @if (msg.Payload is not null)
            {
                <div style="margin-top:6px; font-size:0.9em; color:#555;">
                    📁 @msg.Payload.Category | Priority: @msg.Payload.Priority
                    @if (msg.Payload.Data?.Any() == true)
                    {
                        <span> | Data: @string.Join(", ", msg.Payload.Data.Select(kv => $"{kv.Key}={kv.Value}"))</span>
                    }
                </div>
            }

            @if (msg.Tags?.Any() == true)
            {
                <div style="margin-top:6px;">
                    @foreach (var tag in msg.Tags)
                    {
                        <span style="background:#e0e0e0; padding:2px 8px; border-radius:12px; margin-right:4px; font-size:0.85em;">@tag</span>
                    }
                </div>
            }
        </div>
    }
}

@code {
    private HubConnection? _hubConnection;
    private readonly List<NotificationMessage> _messages = [];

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        _hubConnection = new HubConnectionBuilder()
            .WithUrl(new Uri("http://localhost:7065/notificationhub"))
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<NotificationMessage>("ReceiveNotification", msg =>
        {
            _messages.Insert(0, msg);
            if (_messages.Count > 100) _messages.RemoveAt(100);
            InvokeAsync(StateHasChanged);
        });

        await _hubConnection.StartAsync();
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
            await _hubConnection.DisposeAsync();
    }
}