@page "/token-test"
@rendermode InteractiveServer
@attribute [Authorize]
@using BlazorApp1.Services
@using Microsoft.AspNetCore.Authorization
@using Shared.Auth
@inject BlazorApp1.Services.IAuthService AuthService
@implements IDisposable

<PageTitle>Token Debug Test</PageTitle>

<h1>🔐 Token Debug Test Page</h1>

<div class="alert alert-info">
    <strong>Test Instructions:</strong>
    <ol>
        <li>Token expires in <strong>1 minute</strong> (configured for testing)</li>
        <li>Auto-refresh triggers when token has <strong>30 seconds</strong> remaining</li>
        <li>Watch the console output in Visual Studio for detailed logs</li>
        <li>Click "Fetch User Info" to test authenticated API calls</li>
    </ol>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <strong>⏱️ Token Status (Auto-refreshes every second)</strong>
            </div>
            <div class="card-body">
                @if (_tokenStatus == null)
                {
                    <p>Loading token status...</p>
                }
                else if (!_tokenStatus.HasTokenData)
                {
                    <div class="alert alert-danger">No token data found in cookie!</div>
                }
                else
                {
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Current Time (UTC)</strong></td>
                            <td>@DateTime.UtcNow.ToString("yyyy-MM-dd HH:mm:ss")</td>
                        </tr>
                        <tr class="@(_tokenStatus.IsAccessTokenExpired ? "table-danger" : _tokenStatus.IsAccessTokenExpiringSoon ? "table-warning" : "table-success")">
                            <td><strong>Access Token Expires</strong></td>
                            <td>@_tokenStatus.AccessTokenExpiry?.ToString("yyyy-MM-dd HH:mm:ss") UTC</td>
                        </tr>
                        <tr>
                            <td><strong>Time Until Access Expiry</strong></td>
                            <td>
                                @if (_tokenStatus.TimeUntilAccessExpiry.HasValue)
                                {
                                    var seconds = _tokenStatus.TimeUntilAccessExpiry.Value.TotalSeconds;
                                    if (seconds <= 0)
                                    {
                                        <span class="badge bg-danger">EXPIRED (@seconds.ToString("F0")s ago)</span>
                                    }
                                    else if (seconds <= 30)
                                    {
                                        <span class="badge bg-warning text-dark">@seconds.ToString("F0") seconds (REFRESH ZONE!)</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">@seconds.ToString("F0") seconds</span>
                                    }
                                }
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Access Token Status</strong></td>
                            <td>
                                @if (_tokenStatus.IsAccessTokenExpired)
                                {
                                    <span class="badge bg-danger">❌ EXPIRED</span>
                                }
                                else if (_tokenStatus.IsAccessTokenExpiringSoon)
                                {
                                    <span class="badge bg-warning text-dark">⚠️ EXPIRING SOON (will auto-refresh)</span>
                                }
                                else
                                {
                                    <span class="badge bg-success">✅ VALID</span>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Refresh Token Expires</strong></td>
                            <td>@_tokenStatus.RefreshTokenExpiry?.ToString("yyyy-MM-dd HH:mm:ss") UTC</td>
                        </tr>
                        <tr>
                            <td><strong>Time Until Refresh Expiry</strong></td>
                            <td>@_tokenStatus.TimeUntilRefreshExpiry?.TotalDays.ToString("F2") days</td>
                        </tr>
                    </table>
                }
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <strong>🧪 API Test</strong>
            </div>
            <div class="card-body">
                <button class="btn btn-primary mb-3" @onclick="FetchUserInfo" disabled="@_loading">
                    @if (_loading)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    Fetch User Info from WebApi
                </button>

                @if (_apiCallResult != null)
                {
                    <div class="alert @(_apiCallSuccess ? "alert-success" : "alert-danger")">
                        <strong>@(_apiCallSuccess ? "✅ SUCCESS" : "❌ FAILED")</strong>
                        <br/>
                        <small>Called at: @_apiCallTime?.ToString("HH:mm:ss")</small>
                        <hr/>
                        <pre style="font-size: 0.8em; margin: 0;">@_apiCallResult</pre>
                    </div>
                }

                <hr/>

                <button class="btn btn-warning mb-2" @onclick="ManualRefresh" disabled="@_refreshing">
                    @if (_refreshing)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    🔄 Manual Token Refresh
                </button>

                @if (_refreshResult != null)
                {
                    <div class="alert @(_refreshSuccess ? "alert-success" : "alert-danger")">
                        @_refreshResult
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="card mt-4">
    <div class="card-header bg-dark text-white">
        <strong>📋 Event Log</strong>
        <button class="btn btn-sm btn-outline-light float-end" @onclick="ClearLog">Clear</button>
    </div>
    <div class="card-body" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.85em;">
        @foreach (var entry in _eventLog.AsEnumerable().Reverse())
        {
            <div class="@GetLogClass(entry)">@entry</div>
        }
    </div>
</div>

<div class="mt-4">
    <h5>🔍 What to Test:</h5>
    <table class="table table-bordered">
        <thead class="table-dark">
            <tr>
                <th>Scenario</th>
                <th>How to Test</th>
                <th>Expected Result</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>1. Normal API Call</strong></td>
                <td>Click "Fetch User Info" within 30 seconds of login</td>
                <td>Direct success, no refresh needed</td>
            </tr>
            <tr>
                <td><strong>2. Auto-Refresh</strong></td>
                <td>Wait until "REFRESH ZONE" (under 30s), then click "Fetch User Info"</td>
                <td>Auto-refresh triggers, then API call succeeds</td>
            </tr>
            <tr>
                <td><strong>3. Expired Token</strong></td>
                <td>Wait until "EXPIRED", then click "Fetch User Info"</td>
                <td>Gets 401, triggers refresh, retries, succeeds</td>
            </tr>
            <tr>
                <td><strong>4. Manual Refresh</strong></td>
                <td>Click "Manual Token Refresh" anytime</td>
                <td>New tokens issued, expiry times reset</td>
            </tr>
            <tr>
                <td><strong>5. Page Navigation</strong></td>
                <td>Navigate away and back while in REFRESH ZONE</td>
                <td>Token state persists, refresh works</td>
            </tr>
        </tbody>
    </table>
</div>

@code {
    private TokenStatus? _tokenStatus;
    private System.Threading.Timer? _timer;
    private List<string> _eventLog = new();
    
    private bool _loading;
    private string? _apiCallResult;
    private bool _apiCallSuccess;
    private DateTime? _apiCallTime;
    
    private bool _refreshing;
    private string? _refreshResult;
    private bool _refreshSuccess;

    protected override void OnInitialized()
    {
        Log("Page initialized");
        
        // Update token status every second
        _timer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(() =>
            {
                _tokenStatus = AuthService.GetTokenStatus();
                StateHasChanged();
            });
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
    }

    private async Task FetchUserInfo()
    {
        _loading = true;
        _apiCallResult = null;
        StateHasChanged();

        Log($"API CALL START - Fetching user info...");
        Console.WriteLine($">>> [TEST PAGE] FetchUserInfo: Starting API call at {DateTime.UtcNow:HH:mm:ss} UTC");

        try
        {
            var userInfo = await AuthService.GetAsync<UserInfo>("api/auth/me");
            _apiCallTime = DateTime.UtcNow;
            
            if (userInfo != null)
            {
                _apiCallSuccess = true;
                _apiCallResult = $"Email: {userInfo.Email}\nFirst: {userInfo.FirstName}\nLast: {userInfo.LastName}\nRoles: [{string.Join(", ", userInfo.Roles)}]";
                Log($"API CALL SUCCESS - Got user: {userInfo.Email}");
            }
            else
            {
                _apiCallSuccess = false;
                _apiCallResult = "Failed to fetch user info (null response)";
                Log($"API CALL FAILED - Null response");
            }
        }
        catch (Exception ex)
        {
            _apiCallSuccess = false;
            _apiCallResult = $"Exception: {ex.Message}";
            _apiCallTime = DateTime.UtcNow;
            Log($"API CALL EXCEPTION - {ex.Message}");
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task ManualRefresh()
    {
        _refreshing = true;
        _refreshResult = null;
        StateHasChanged();

        Log($"MANUAL REFRESH START");
        Console.WriteLine($">>> [TEST PAGE] ManualRefresh: Starting at {DateTime.UtcNow:HH:mm:ss} UTC");

        try
        {
            var success = await AuthService.RefreshTokenIfNeededAsync();
            
            if (success)
            {
                _refreshSuccess = true;
                _refreshResult = $"✅ Tokens refreshed successfully at {DateTime.UtcNow:HH:mm:ss} UTC";
                Log($"MANUAL REFRESH SUCCESS");
            }
            else
            {
                _refreshSuccess = false;
                _refreshResult = "❌ Token refresh failed - check console for details";
                Log($"MANUAL REFRESH FAILED");
            }
        }
        catch (Exception ex)
        {
            _refreshSuccess = false;
            _refreshResult = $"❌ Exception: {ex.Message}";
            Log($"MANUAL REFRESH EXCEPTION - {ex.Message}");
        }
        finally
        {
            _refreshing = false;
            _tokenStatus = AuthService.GetTokenStatus();
            StateHasChanged();
        }
    }

    private void Log(string message)
    {
        var entry = $"[{DateTime.UtcNow:HH:mm:ss}] {message}";
        _eventLog.Add(entry);
        
        // Keep only last 50 entries
        if (_eventLog.Count > 50)
            _eventLog.RemoveAt(0);
    }

    private string GetLogClass(string entry)
    {
        if (entry.Contains("SUCCESS")) return "text-success";
        if (entry.Contains("FAILED") || entry.Contains("EXCEPTION")) return "text-danger";
        if (entry.Contains("REFRESH")) return "text-warning";
        return "";
    }

    private void ClearLog()
    {
        _eventLog.Clear();
        StateHasChanged();
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }
}
