@page "/token-test"
@rendermode InteractiveServer
@attribute [Authorize]
@using BlazorApp1.Services
@using Microsoft.AspNetCore.Authorization
@using Shared.Auth
@inject IAuthService AuthService
@implements IDisposable

<PageTitle>Token Debug Test</PageTitle>

<h1>Token Debug Test Page</h1>

<div class="alert alert-info">
    <strong>Instructions:</strong> Token expires in ~1 min. Auto-refresh triggers at 30s remaining.
    Watch Visual Studio Output for <code>[AUTH]</code> prefixed logs.
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <strong>Token Status (updates every second)</strong>
            </div>
            <div class="card-body">
                @if (_tokenStatus == null || !_tokenStatus.HasTokenData)
                {
                    <div class="alert alert-danger">No tokens in server cache!</div>
                }
                else
                {
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Now (UTC)</strong></td>
                            <td>@DateTime.UtcNow.ToString("HH:mm:ss")</td>
                        </tr>
                        <tr class="@GetAccessRowClass()">
                            <td><strong>Access Expires</strong></td>
                            <td>@_tokenStatus.AccessTokenExpiry?.ToString("HH:mm:ss") UTC</td>
                        </tr>
                        <tr>
                            <td><strong>Time Left</strong></td>
                            <td>
                                @if (_tokenStatus.TimeUntilAccessExpiry.HasValue)
                                {
                                    var s = _tokenStatus.TimeUntilAccessExpiry.Value.TotalSeconds;
                                    <span class="badge @(s <= 0 ? "bg-danger" : s <= 30 ? "bg-warning text-dark" : "bg-success")">
                                        @(s <= 0 ? $"EXPIRED ({s:F0}s ago)" : $"{s:F0}s")
                                    </span>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Refresh Expires</strong></td>
                            <td>@_tokenStatus.RefreshTokenExpiry?.ToString("yyyy-MM-dd HH:mm") UTC</td>
                        </tr>
                    </table>
                }
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-secondary text-white"><strong>API Test</strong></div>
            <div class="card-body">
                <button class="btn btn-primary mb-2" @onclick="FetchUserInfo" disabled="@_loading">
                    @if (_loading)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    Fetch User Info
                </button>

                <button class="btn btn-warning mb-2" @onclick="ManualRefresh" disabled="@_refreshing">
                    @if (_refreshing)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    Manual Refresh
                </button>

                @if (_lastResult != null)
                {
                    <div class="alert @(_lastSuccess ? "alert-success" : "alert-danger") mt-2">
                        <small>@_lastTime?.ToString("HH:mm:ss")</small> — @_lastResult
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="card mt-3">
    <div class="card-header bg-dark text-white">
        Event Log <button class="btn btn-sm btn-outline-light float-end" @onclick="() => _log.Clear()">Clear</button>
    </div>
    <div class="card-body" style="max-height:250px; overflow-y:auto; font-family:monospace; font-size:0.85em;">
        @foreach (var e in _log.AsEnumerable().Reverse())
        {
            <div class="@(e.Contains("SUCCESS") ? "text-success" : e.Contains("FAIL") ? "text-danger" : "")">@e</div>
        }
    </div>
</div>

@code {
    private TokenStatus? _tokenStatus;
    private Timer? _timer;
    private List<string> _log = new();
    private bool _loading, _refreshing;
    private string? _lastResult;
    private bool _lastSuccess;
    private DateTime? _lastTime;

    protected override void OnInitialized()
    {
        Log("Page loaded");
        _timer = new Timer(async _ =>
        {
            await InvokeAsync(() => { _tokenStatus = AuthService.GetTokenStatus(); StateHasChanged(); });
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
    }

    private async Task FetchUserInfo()
    {
        _loading = true; StateHasChanged();
        Log("Fetching user info...");

        try
        {
            var info = await AuthService.GetAsync<UserInfo>("api/auth/me");
            _lastTime = DateTime.UtcNow;
            _lastSuccess = info != null;
            _lastResult = info != null
                ? $"SUCCESS — {info.Email} [{string.Join(",", info.Roles)}]"
                : "FAILED — null response";
            Log(_lastResult);
        }
        catch (Exception ex)
        {
            _lastTime = DateTime.UtcNow;
            _lastSuccess = false;
            _lastResult = $"FAILED — {ex.Message}";
            Log(_lastResult);
        }
        finally { _loading = false; StateHasChanged(); }
    }

    private async Task ManualRefresh()
    {
        _refreshing = true; StateHasChanged();
        Log("Manual refresh...");

        var ok = await AuthService.RefreshTokenAsync();
        _lastTime = DateTime.UtcNow;
        _lastSuccess = ok;
        _lastResult = ok ? "SUCCESS — tokens refreshed" : "FAILED — see VS output for [AUTH] logs";
        Log(_lastResult);

        _tokenStatus = AuthService.GetTokenStatus();
        _refreshing = false; StateHasChanged();
    }

    private string GetAccessRowClass() =>
        _tokenStatus?.IsAccessTokenExpired == true ? "table-danger" :
        _tokenStatus?.IsAccessTokenExpiringSoon == true ? "table-warning" : "table-success";

    private void Log(string msg)
    {
        _log.Add($"[{DateTime.UtcNow:HH:mm:ss}] {msg}");
        if (_log.Count > 50) _log.RemoveAt(0);
    }

    public void Dispose() => _timer?.Dispose();
}
